@model Fast.Web.Models.CustomerListModel
@using Fast.Web.Resources;
@using Newtonsoft.Json;

@{
    var territories = Model.Customers.Select(x => x.teritorry).Distinct().ToList();
    var counter = 1;
    Dictionary<string, string> colors = new Dictionary<string,string>();
    colors.Add("color1", "ed53ed");
    colors.Add("color2", "f2f261");
    colors.Add("color3", "5959ff");
    colors.Add("color4", "62d962");
    colors.Add("color5", "ff4050");
    colors.Add("color6", "f5c60c");
    colors.Add("color7", "c1c1c1");
    colors.Add("color8", "cca166");
    colors.Add("color9", "000000");
}

@section Styles{
    <link href="~/Content/dashforge/assets/css/dashforge.css" rel="stylesheet">

    <style>
    </style>
}

<div class="content content-fixed content-auth-alt pd-0-f">
    <div class="container-fluid ht-100p pd-0-f">
        <div class="ht-100p d-flex flex-column">
            <div class="row">
                <div class="col-10">
                    <div id="map" style="min-height:500px"></div>
                </div>
                <div class="col-2">
                    <br>
                    Use Ctrl+click to select multiple markers, or
                    click some point to draw shape around markers to select them.
                    <br><br>

                    Selected markers:
                    <div class="form-group">
                        <textarea id="selected_markers" class="form-control" rows="3"></textarea>
                    </div>

                    Place to territory:
                    @foreach (var teri in territories)
                    {
                        <div class="custom-control custom-radio" style="background-color: #@(colors["color"+counter]);padding: 5px 2rem;">
                            <input type="radio" name="territory" id="@(teri)" value="@(counter++)" class="custom-control-input">
                            <label class="custom-control-label" for="@(teri)">@teri</label>
                        </div>
                    }

                    <div class="row pd-20">
                        <button type="button" class="btn btn-danger col-6" onclick="clearSelection()">Reset</button>
                        <button type="button" class="btn btn-primary col-6" onclick="applySelection()">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- container -->
</div><!-- content -->

@section Scripts{
    <script src="~/Content/theme/js/jquery-1.10.0.min.js"></script>
    <script src="~/Content/dashforge/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpjc1xdCmFJ6pptU_NVA54Cjpi_kqFaEU&libraries=geometry"></script>

    <script type="text/javascript">
        var allcusts = @(Html.Raw((JsonConvert.SerializeObject(Model.Customers)).Replace("\n", "").Replace("\r", "").Replace("\t", "").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"")));
        var allterritories = @(Html.Raw((JsonConvert.SerializeObject(territories)).Replace("\n", "").Replace("\r", "").Replace("\t", "").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"").Replace(" \"", "\"")));

        console.log(allterritories);

        var map;
        var markers = [];
        var markerselected = [];
        var selecting = false;
        var polygon;
        var polygonMarkers = [];
        var polygonLocations = [];
        var geocoder = new google.maps.Geocoder();
        var infoWindow;
        var icons = ["mm_20_purple",
            "mm_20_yellow",
            "mm_20_blue",
            "mm_20_green",
            "mm_20_red",
            "mm_20_orange",
            "mm_20_gray",
            "mm_20_brown",
            "mm_20_black"];

        var icon_selected = "mm_20_white";

        window.onkeydown = function(e) {
            selecting = ((e.keyIdentifier == 'Control') || (e.ctrlKey == true));
        }
        window.onkeyup = function(e) {
            selecting = false;
        }

        function initialize() {
            //******************************************************************************************** INIT GMAP
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 0, lng: 0},
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            infoWindow = new google.maps.InfoWindow();

            //******************************************************************************************** SET CENTER OF THE MAP
            geocoder.geocode({'address': "@(Model.Customers[0].kecamatan + " " + Model.Customers[0].dati_II) indonesia"}, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });

            function addMarkerEvent(marker, info) {
                //******************************************************************************************** KETIKA MARKER DROP
                google.maps.event.addListener(marker, "dragend", function (event) {
                    var lat = event.latLng.lat();
                    var lng = event.latLng.lng();

                    console.log(lat + ' , ' + lng);
                    console.log(marker.get('customer_code'));

                    for (var i = 0, allcust; allcust = allcusts[i]; i++) {
                        if (allcust.customer_code == marker.get('customer_code')) {
                            var locat = new google.maps.LatLng(lat, lng);
                            allcusts[i].koordinat = locat;
                        }
                    }

                });

                //******************************************************************************************** KETIKA MARKER CLICKED
                google.maps.event.addListener(marker, "click", function (e) {
                    if (selecting) {
                        marker.setIcon("http://labs.google.com/ridefinder/images/" + icon_selected + ".png");
                        markerselected.push(marker);

                        var a = 260891;
                        if (document.getElementById('selected_markers').value == '') {
                            a = 0;
                        }
                        document.getElementById('selected_markers').value += (a > 0 ? ', ' : '') + marker.get('customer_code');

                    } else {
                        clearSelection();
                        markerselected.push(marker);
                        marker.setIcon("http://labs.google.com/ridefinder/images/" + icon_selected + ".png");
                        document.getElementById('selected_markers').value = marker.get('customer_code');
                    }

                    
                    console.log(markerselected);

                    infoWindow.setContent(info);
                    infoWindow.open(map, marker);
                });
            }

            //******************************************************************************************** GAMBAR MARKER
            function initmarker() {
                var counter = -1;
                var last_territory = 0;
                for (var i = 0, allcust; allcust = allcusts[i]; i++) {
                    if (last_territory != allcust.teritorry) {
                        counter++;
                        console.log(last_territory);
                        last_territory = allcust.teritorry;
                    }

                    var locat = new google.maps.LatLng(allcust.geographical_x, allcust.geographical_y);
                    allcusts[i].koordinat = locat;
                    marker = new google.maps.Marker({
                        position: locat,
                        draggable: true,
                        icon: "http://labs.google.com/ridefinder/images/" + icons[counter] + ".png",
                        //animation: google.maps.Animation.DROP,
                        map: map,
                        customer_code: allcust.customer_code,
                        default_icon: "http://labs.google.com/ridefinder/images/" + icons[counter] + ".png",
                        title: allcust.customer_code + " (" + allcust.teritorry + ")"
                    });

                    addMarkerEvent(marker, '<b>' + allcust.customer_code + '</b><br>' + allcust.customer_name + '<br>' + allcust.customer_address + '<br>' + allcust.teritorry);
                    markers[allcust.customer_code] = marker;
                }
            }
            initmarker();
            

            //******************************************************************************************** GAMBAR POLYGON UNTUK SELECTION
            google.maps.event.addListener(map, 'click', function (e) {
                // set a marker there, with a small measle icon
                var position = e.latLng;
                polygonLocations.push(position);
                polygonMarkers.push(new google.maps.Marker({
                    icon: 'https://maps.gstatic.com/intl/en_ALL/mapfiles/markers2/measle.png',
                    position: position,
                    map: map
                }));
                // now let's add a polygon
                drawPolygon(polygonLocations);
            });
        }

        // draws a polygon
        function drawPolygon(points) {
            if (points.length < 3) {
                return;
            }
            // first delete the previous polygon
            if (polygon) {
                polygon.setMap(null);
            }

            polygon = new google.maps.Polygon({
                paths: points,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map
            });
            // display to input
            displaySelectedMarkers(polygon);
        }

        // display the selected markers to input.
        function displaySelectedMarkers(polygon) {
            var a = 260891;
            if (document.getElementById('selected_markers').value == '') {
                a = 0;
            }

            for (var i = 0, allcust; allcust = allcusts[i]; i++) {

                if (google.maps.geometry.poly.containsLocation(allcust.koordinat, polygon)) {
                    document.getElementById('selected_markers').value += (a++ > 0 ? ', ' : '') + allcust.customer_code;
                    (markers[allcust.customer_code]).setIcon("http://labs.google.com/ridefinder/images/" + icon_selected + ".png");
                    markerselected.push((markers[allcust.customer_code]));
                }
            }
        }

        function clearSelection() {
            if (polygon) {
                polygon.setMap(null);
            }
            for (var i in polygonMarkers) {
                polygonMarkers[i].setMap(null);
            }
            polygonLocations = [];

            console.log("marker selected:");
            console.log(markerselected);
            if (markerselected.length > 0) {
                for (var i = 0, mark; mark = markerselected[i]; i++) {
                    mark.setIcon(mark.get('default_icon'));
                }
            }
            markerselected = [];

            document.getElementById('selected_markers').value = '';
        }

        function applySelection() {
            var radioValue = $("input[name='territory']:checked").val();
            radioValue = radioValue - 1;
            var radioID = $("input[name='territory']:checked").attr('id');

            console.log(radioValue);
            console.log(radioID);

            if (radioID === undefined) {
                alert("Please select territory above!");
            } else {
                if (markerselected.length > 0) {
                    for (var i = 0, mark; mark = markerselected[i]; i++) {
                        //mark.setIcon("http://labs.google.com/ridefinder/images/" + icons[radioValue] + ".png");
                        mark.default_icon = "http://labs.google.com/ridefinder/images/" + icons[radioValue] + ".png";
                    }
                }
            }

            clearSelection();
        }

        
        $(document).ready(function () {
            google.maps.event.addDomListener(window, 'load', initialize);
        });
    </script>
}